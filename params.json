{
  "name": "Seamless Integration",
  "tagline": "CinetPay Seamless Integration permet d'integrer facilement CinetPay de façon transparente à son service",
  "body": "# [CinetPay](http://www.cinetpay.com) Seamless Integration\r\n\r\nCinetPay Seamless Integration permet d'intégrer facilement CinetPay de façon transparente à son service en ligne, c'est à dire que le client effectue le paiement sans quitter le site\r\ndu marchand.\r\n\r\n_Il vous faut au préalable avoir une autorisation par CinetPay pour utiliser le seamless Integration_\r\n\r\n_Pour avoir une autorisation, veuillez envoyez un mail à [support@cinetpay.com](mailto:support@cinetpay.com)_\r\n\r\nL'integration de ce SDK se fait en trois etapes :\r\n\r\n## Etape 1 : Préparer la page de notification\r\n\r\nPour ceux qui possèdent des services qui ne neccessitent pas un traitement des notifications de paiement de CinetPay, vous pouvez passer directement à l'etape 2, par exemple les services de don.\r\n\r\nA chaque paiement, CinetPay vous notifie via un lien de notification, nous vous conseillons de toujours le traiter côté serveur. Nous allons utiliser PHP dans ce cas de figure :\r\nScript index.php dans http://mondomaine.com/notify/ (le script doit se trouver dans le repertoire de votre url notify_url) ;\r\n```php\r\n<?php\r\nif (isset($_POST['cpm_trans_id'])) {\r\n    // SDK PHP de CinetPay \r\n    require_once __DIR__ . '/cinetPay.php';\r\n    require_once __DIR__ . '/commande.php';\r\n\r\n    //La classe commande correspond à votre colonne qui gère les transactions dans votre base de données\r\n    $commande = new Commande();\r\n    try {\r\n        // Initialisation de CinetPay et Identification du paiement\r\n        $id_transaction = $_POST['cpm_trans_id'];\r\n        $apiKey = _VOTRE_APIKEY_;\r\n        $site_id = _VOTRE_SITEID_;\r\n        $plateform = \"TEST\"; // Valorisé à PROD si vous êtes en production\r\n        $CinetPay = new CinetPay($site_id, $apiKey, $plateform);\r\n        // Reprise exacte des bonnes données chez CinetPay\r\n        $CinetPay->setTransId($id_transaction)->getPayStatus();\r\n        $cpm_site_id = $CinetPay->_cpm_site_id;\r\n        $signature = $CinetPay->_signature;\r\n        $cpm_amount = $CinetPay->_cpm_amount;\r\n        $cpm_trans_id = $CinetPay->_cpm_trans_id;\r\n        $cpm_custom = $CinetPay->_cpm_custom;\r\n        $cpm_currency = $CinetPay->_cpm_currency;\r\n        $cpm_payid = $CinetPay->_cpm_payid;\r\n        $cpm_payment_date = $CinetPay->_cpm_payment_date;\r\n        $cpm_payment_time = $CinetPay->_cpm_payment_time;\r\n        $cpm_error_message = $CinetPay->_cpm_error_message;\r\n        $payment_method = $CinetPay->_payment_method;\r\n        $cpm_phone_prefixe = $CinetPay->_cpm_phone_prefixe;\r\n        $cel_phone_num = $CinetPay->_cel_phone_num;\r\n        $cpm_ipn_ack = $CinetPay->_cpm_ipn_ack;\r\n        $created_at = $CinetPay->_created_at;\r\n        $updated_at = $CinetPay->_updated_at;\r\n        $cpm_result = $CinetPay->_cpm_result;\r\n        $cpm_trans_status = $CinetPay->_cpm_trans_status;\r\n        $cpm_designation = $CinetPay->_cpm_designation;\r\n        $buyer_name = $CinetPay->_buyer_name;\r\n\r\n        // Recuperation de la ligne de la transaction dans votre base de données\r\n        $commande->setTransId($id_transaction);\r\n        $commande->getCommandeByTransId();\r\n        // Verification de l'etat du traitement de la commande\r\n        if ($commande->getStatut() == '00') {\r\n            // La commande a été déjà traité\r\n            // Arret du script\r\n            die();\r\n        }\r\n        // Dans le cas contrait, on remplit notre ligne des nouvelles données acquise en cas de tentative de paiement sur CinetPay\r\n        $commande->setMethode($payment_method);\r\n        $commande->setPayId($cpm_payid);\r\n        $commande->setBuyerName($buyer_name);\r\n        $commande->setSignature($signature);\r\n        $commande->setPhone($cel_phone_num);\r\n        $commande->setDatePaiement($cpm_payment_date . ' ' . $cpm_payment_time);\r\n\r\n        // On verifie que le montant payé chez CinetPay correspond à notre montant en base de données pour cette transaction\r\n        if ($commande->getMontant() == $cpm_amount) {\r\n            // C'est OK : On continue le remplissage des nouvelles données\r\n            $commande->setErrorMessage($cpm_error_message);\r\n            $commande->setStatut($cpm_result);\r\n            $commande->setTransStatus($cpm_trans_status);\r\n            if($cpm_result == '00'){\r\n                //Le paiement est bon\r\n                // Traitez et delivrez le service au client\r\n            }else{\r\n                //Le paiement a échoué\r\n            }\r\n        } else {\r\n            //Fraude : montant payé ' . $cpm_amount . ' ne correspond pas au montant de la commande\r\n            $commande->setStatut('-1');\r\n            $commande->setTransStatus('REFUSED');\r\n        }\r\n        // On met à jour notre ligne\r\n        $commande->update();\r\n    } catch (Exception $e) {\r\n        echo \"Erreur :\" . $e->getMessage();\r\n        // Une erreur s'est produite\r\n    }\r\n} else {\r\n    // Tentative d'accès direct au lien IPN\r\n}\r\n?>\r\n```\r\n## Etape 2 : Préparation du formulaire de paiement\r\n\r\nAvant de commencer cette etape, il faut lier le seamless SDK à votre page :\r\n\r\n* `https://www.cinetpay.com/cdn/seamless_sdk/latest/cinetpay.sandbox.min.js` : si vous êtes en test\r\n* `https://www.cinetpay.com/cdn/seamless_sdk/latest/cinetpay.prod.min.js`    : si vous êtes en production\r\n\r\nCela se fait dans la balise head de votre page web\r\n\r\nExemple (en TEST) :\r\n```html\r\n   <head>\r\n       ...\r\n       <script charset=\"utf-8\" \r\n               src=\"https://www.cinetpay.com/cdn/seamless_sdk/latest/cinetpay.sandbox.min.js\"\r\n               type=\"text/javascript\">\r\n       </script>\r\n   </head> \r\n```\r\n\r\n####Creation du formulaire CinetPay\r\n\r\nLe formulaire de paiement CinetPay est constitué de :\r\n* `amount`      : Montant du paiement\r\n* `currency`    : Devise du paiement, toujours en CFA pour le moment\r\n* `trans_id`    : L'identifiant de la transaction, elle est unique\r\n* `designation` : La designation de votre paiement\r\n* `notify_url`  : le lien de notification silencieuse (IPN) après paiement\r\n\r\nExemple :\r\n\r\n```html\r\n<p id=\"payment_result\"></p>\r\n<form id=\"info_paiement\">\r\n    <input type=\"hidden\"  id=\"amount\" value=\"10\">\r\n\r\n    <input type=\"hidden\" id=\"currency\" value=\"CFA\">\r\n    \r\n    <input type=\"hidden\" id=\"trans_id\" value=\"\">\r\n    \r\n    <input type=\"hidden\" id=\"cpm_custom\" value=\"\">\r\n\r\n    <input type=\"hidden\" id=\"designation\" value=\"Achat de chaussure noir\">\r\n    \r\n    <button type=\"submit\" id=\"process_payment\">Proceder au Paiement</button>    \r\n</form>\r\n```\r\nNB : _Avant l'affichage de ce formulaire, vous devez enregistrer les informations concernant cette transaction dans votre base de données afin de les verifier après paiement du client_\r\n\r\n####Lier le formulaire au SDK Javascript\r\n\r\nSur clic du bouton \"Proceder au Paiement\", Nous allons recuperer le montant de la transaction, l'identifiant de la transaction, la devise, la désignation et l'url de notification pour debuter le processus de paiement transparent sur CinetPay\r\nExemple (fichier payment.js) :\r\n```html\r\n<script >\r\n    CinetPay.setConfig({\r\n            apikey: '174323661757617531bf99c9.80613927',\r\n            site_id: 393509,\r\n            notify_url: 'http://mondomaine.com/notify/'\r\n        });\r\n    var process_payment = document.getElementById('process_payment');\r\n        process_payment.addEventListener('click', function () {\r\n            CinetPay.setSignatureData({\r\n                amount: parseInt(document.getElementById('amount').value),\r\n                trans_id: document.getElementById('trans_id').value,\r\n                currency: document.getElementById('currency').value,\r\n                designation: document.getElementById('designation').value,\r\n                custom: document.getElementById('cpm_custom').value\r\n            });\r\n            CinetPay.getSignature();\r\n        });\r\n</script>\r\n```\r\n\r\n## Etape 3 : Observer  le paiement transparent\r\n\r\nLorsque le client se trouve sur le guichet de CinetPay, Vous pouvez suivre l'etat d'avancement du client sur CinetPay grace à ces evènements :\r\n\r\n* `error`              : Une erreur s'est produite, les requëtes ajax ou le paiement ont echoué,\r\n* `paymentPending`     : Le paiement est en cours\r\n* `paymentSuccessfull` : Le paiement est terminé, Le paiement est valide ou est annulé\r\n\r\nExemple (suite du fichier payment.js):\r\n\r\n```html\r\n<script >\r\n   var result_div = document.getElementById('payment_result');\r\n   CinetPay.on('error', function (e) {\r\n        result_div.innerHTML = '';\r\n        result_div.innerHTML += '<b>Error code:</b>' + e.code + '<br><b>Message:</b>:' + e.message;\r\n   });\r\n   CinetPay.on('paymentPending', function (e) {\r\n       result_div.innerHTML = '';\r\n        result_div.innerHTML = 'Paiement en cours <br>';\r\n        result_div.innerHTML += '<b>code:</b>' + e.code + '<br><b>Message:</b>:' + e.message;\r\n   });\r\n   CinetPay.on('paymentSuccessfull', function (paymentInfo) {\r\n           if(typeof paymentInfo.lastTime != 'undefined'){\r\n               result_div.innerHTML = '';\r\n               if(paymentInfo.cpm_result == '00'){\r\n                   result_div.innerHTML = 'Votre paiement a été validé avec succès : <br> Montant payé :'+paymentInfo.cpm_amount+'<br>';\r\n               }else{\r\n                   result_div.innerHTML = 'Une erreur est survenue :'+paymentInfo.cpm_error_message;\r\n               }\r\n           }\r\n   });\r\n</script>\r\n```\r\n\r\n## Compatibilité Navigateurs Web\r\n\r\nCinetPay Seamless Integration a été testé et fonctionne sur tous les navigateurs modernes y compris :\r\n\r\n* Chrome\r\n* Safari\r\n* Firefox\r\n* Internet Explorer 8+.\r\n\r\n## Compatibilité Application Hybride\r\n\r\nCinetPay Seamless Integration a été testé et fonctionne sur :\r\n\r\n* Cordova\r\n* phoneGap\r\n* Ionic\r\n* jQuery Mobile\r\n\r\n## Votre Api Key et Site ID\r\n\r\nCes informations sont disponibles dans votre BackOffice CinetPay.\r\n\r\n## Exemple Intégration\r\n\r\nVous trouverez un exemple d'intégration complet dans le dossier exemple/html/\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}